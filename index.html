<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ダイアトニックコード・クイズ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .result-table th, .result-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl bg-white rounded-2xl shadow-lg p-6 md:p-8">
        
        <!-- Start Screen -->
        <div id="start-screen">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-gray-900">ダイアトニックコード・クイズ</h1>
                <p class="text-gray-500 mt-2">指定されたキーのダイアトニックコードを答えよう！</p>
            </div>
            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                <label for="user-name" class="block text-sm font-medium text-gray-700 mb-1">回答者名</label>
                <input type="text" id="user-name" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="名前を入力してください">
            </div>
            <div class="text-center">
                <button id="start-game-btn" class="w-full sm:w-auto px-10 py-4 bg-indigo-600 text-white font-bold text-xl rounded-lg shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">
                    スタート
                </button>
            </div>
        </div>

        <!-- Quiz Screen -->
        <div id="quiz-screen" class="hidden">
            <!-- Quiz Header -->
            <div class="flex justify-between items-center mb-4">
                <h2 id="quiz-title" class="text-xl font-semibold text-gray-800"></h2>
                <div id="timer" class="text-2xl font-mono font-semibold text-indigo-600">00:00.0</div>
            </div>

            <!-- Quiz Area -->
            <div id="answers-grid" class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-7 gap-3 mb-6">
                <!-- Answer inputs will be generated here -->
            </div>

            <!-- Action Buttons and Feedback -->
            <div class="text-center mb-6">
                <button id="submit-btn" class="px-8 py-3 bg-green-500 text-white font-bold rounded-lg shadow-lg hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-transform transform hover:scale-105">
                    答え合わせ
                </button>
                <button id="next-question-btn" class="hidden px-8 py-3 bg-blue-500 text-white font-bold rounded-lg shadow-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:scale-105">
                    次の問題へ
                </button>
                <div id="feedback" class="mt-4 text-lg font-medium h-6"></div>
            </div>
            
            <!-- Results Area -->
            <div class="border-t pt-6">
                <div class="text-center">
                    <button id="toggle-results-btn" class="w-full sm:w-auto px-6 py-2 bg-gray-200 text-gray-700 font-semibold rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">
                        結果を見る
                    </button>
                </div>
                <div id="results-container" class="hidden mt-4 max-h-60 overflow-y-auto">
                     <table class="w-full text-sm result-table">
                        <thead>
                            <tr>
                                <th>日時</th>
                                <th>回答者</th>
                                <th>問題</th>
                                <th>かかった時間</th>
                                <th>ミス回数</th>
                            </tr>
                        </thead>
                        <tbody id="results-body">
                            <!-- Results will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, query, getDocs, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your web app's Firebase configuration
        // ▼▼▼ ここにFirebaseの設定を貼り付け ▼▼▼
        const firebaseConfig = {
          apiKey: "AIzaSyCOIicc6JflKhz_o9irJ_qJRTI7Wr2IELk",
          authDomain: "diatonic-quiz-app.firebaseapp.com",
          projectId: "diatonic-quiz-app",
          storageBucket: "diatonic-quiz-app.firebasestorage.app",
          messagingSenderId: "1045630189799",
          appId: "1:1045630189799:web:083f74322758f451f9a242"
        };
        // ▲▲▲ ここまで ▲▲▲

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- Music Theory Logic ---
        const ALL_KEYS = ['C', 'G', 'D', 'A', 'E', 'B', 'F#', 'C#', 'F', 'Bb', 'Eb', 'Ab'];
        const NOTES_SHARP = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const NOTES_FLAT = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];
        const SHARP_KEYS = ['C', 'G', 'D', 'A', 'E', 'B', 'F#', 'C#'];
        const SCALE_INTERVALS = { major: [0, 2, 4, 5, 7, 9, 11], minor: [0, 2, 3, 5, 7, 8, 10] };
        const CHORD_QUALITIES = {
            major: { triad: ['', 'm', 'm', '', '', 'm', 'mb5'], seventh: ['Maj7', 'm7', 'm7', 'Maj7', '7', 'm7', 'm7b5'] },
            minor: { triad: ['m', 'mb5', '', 'm', 'm', '', ''], seventh: ['m7', 'm7b5', 'Maj7', 'm7', 'm7', 'Maj7', '7'] }
        };

        // --- State Management ---
        let currentCorrectAnswers = [];
        let currentQuizInfo = {};
        let timerInterval = null;
        let startTime = 0;
        let mistakeCount = 0;

        // --- DOM Elements ---
        const startScreen = document.getElementById('start-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const userNameInput = document.getElementById('user-name');
        const startGameBtn = document.getElementById('start-game-btn');
        const quizTitle = document.getElementById('quiz-title');
        const timerDisplay = document.getElementById('timer');
        const answersGrid = document.getElementById('answers-grid');
        const submitBtn = document.getElementById('submit-btn');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const feedback = document.getElementById('feedback');
        const toggleResultsBtn = document.getElementById('toggle-results-btn');
        const resultsContainer = document.getElementById('results-container');
        const resultsBody = document.getElementById('results-body');

        // --- Timer Functions ---
        function formatTime(ms) {
            const minutes = Math.floor(ms / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            const milliseconds = Math.floor((ms % 1000) / 100);
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${milliseconds}`;
        }

        function startTimer() {
            startTime = Date.now();
            mistakeCount = 0;
            timerInterval = setInterval(() => {
                const elapsedTime = Date.now() - startTime;
                timerDisplay.textContent = formatTime(elapsedTime);
            }, 100);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        // --- Quiz Logic ---
        function startRandomQuiz() {
            const randomKey = ALL_KEYS[Math.floor(Math.random() * ALL_KEYS.length)];
            const randomScale = Math.random() < 0.5 ? 'major' : 'minor';
            const randomChordType = Math.random() < 0.5 ? 'triad' : 'seventh';
            
            const scaleText = randomScale === 'major' ? 'メジャー' : 'マイナー';
            const chordTypeText = randomChordType === 'triad' ? '三和音' : '四和音';

            currentQuizInfo = { key: randomKey, scale: randomScale, chordType: randomChordType, scaleText, chordTypeText };
            
            quizTitle.textContent = `${randomKey} ${scaleText}スケール (${chordTypeText})`;
            currentCorrectAnswers = generateDiatonicChords(randomKey, randomScale, randomChordType);

            answersGrid.innerHTML = '';
            const romanNumerals = ['I', 'II', 'III', 'IV', 'V', 'VI', 'VII'];
            for (let i = 0; i < 7; i++) {
                const wrapper = document.createElement('div');
                const label = document.createElement('label');
                label.className = "block text-sm font-medium text-center text-gray-500 mb-1";
                label.textContent = romanNumerals[i];
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'answer-input w-full p-2 text-center border-gray-300 border rounded-md focus:ring-indigo-500 focus:border-indigo-500 transition-colors';
                wrapper.appendChild(label);
                wrapper.appendChild(input);
                answersGrid.appendChild(wrapper);
            }
            
            feedback.textContent = '';
            submitBtn.classList.remove('hidden');
            nextQuestionBtn.classList.add('hidden');
            startTimer();
        }

        function generateDiatonicChords(rootNote, scaleType, chordType) {
            const useSharp = SHARP_KEYS.includes(rootNote);
            const noteSet = useSharp ? NOTES_SHARP : NOTES_FLAT;
            const rootIndex = noteSet.indexOf(rootNote.split(' ')[0]);
            const scaleIntervals = SCALE_INTERVALS[scaleType];
            const chordQualities = CHORD_QUALITIES[scaleType][chordType];
            return scaleIntervals.map((interval, i) => {
                const noteIndex = (rootIndex + interval) % 12;
                return `${noteSet[noteIndex]}${chordQualities[i]}`;
            });
        }
        
        function normalizeAnswer(input) {
            if (!input) return "";
            let text = input.trim();
            text = text.replace(/△7|Δ7/g, 'Maj7').replace(/ø7|ø/g, 'm7b5').replace(/°/g, 'mb5').replace(/dim$/ig, 'mb5').replace(/(m-5|mb5)$/ig, 'mb5').replace(/-7/g, 'm7').replace(/ma7/ig, 'Maj7').replace(/M7/g, 'Maj7').replace(/m7b5/i, 'm7b5');
            if (text.endsWith('-') && text.length > 1) text = text.slice(0, -1) + 'm';
            if (text.endsWith('o') && text.length > 1) text = text.slice(0, -1) + 'dim';
            const rootMatch = text.match(/^[A-G][#b]?/i);
            if (!rootMatch) return text;
            let root = rootMatch[0];
            let quality = text.substring(root.length);
            root = root.charAt(0).toUpperCase() + root.slice(1).toLowerCase();
            if (quality.toLowerCase() === 'maj7') quality = 'Maj7';
            if (quality.toLowerCase() === 'm' && text.endsWith('m')) quality = 'm';
            return root + quality;
        }
        
        function getEnharmonicEquivalents(chord) {
            const equivalents = {'C#':'Db','Db':'C#','D#':'Eb','Eb':'D#','F#':'Gb','Gb':'F#','G#':'Ab','Ab':'G#','A#':'Bb','Bb':'A#'};
            const match = chord.match(/^[A-G][#b]?/);
            if (!match) return [chord];
            const root = match[0];
            const quality = chord.substring(root.length);
            const enharmonicRoot = equivalents[root];
            return enharmonicRoot ? [chord, enharmonicRoot + quality] : [chord];
        }

        async function checkAnswers() {
            const inputs = document.querySelectorAll('.answer-input');
            const userAnswers = Array.from(inputs).map(input => normalizeAnswer(input.value));
            let allCorrect = true;
            userAnswers.forEach((answer, i) => {
                const possibleAnswers = getEnharmonicEquivalents(currentCorrectAnswers[i]);
                if (possibleAnswers.includes(answer)) {
                    inputs[i].classList.remove('border-red-500', 'bg-red-50');
                    inputs[i].classList.add('border-green-500', 'bg-green-50');
                } else {
                    inputs[i].classList.remove('border-green-500', 'bg-green-50');
                    inputs[i].classList.add('border-red-500', 'bg-red-50');
                    allCorrect = false;
                }
            });
            if (allCorrect) {
                stopTimer();
                feedback.textContent = `正解！タイム: ${timerDisplay.textContent}`;
                feedback.className = 'mt-4 text-lg font-medium h-6 text-green-600';
                submitBtn.classList.add('hidden');
                nextQuestionBtn.classList.remove('hidden');
                await saveResult();
            } else {
                mistakeCount++;
                feedback.textContent = `惜しい！ミス: ${mistakeCount}回`;
                feedback.className = 'mt-4 text-lg font-medium h-6 text-red-600';
            }
        }

        async function saveResult() {
            const userName = userNameInput.value.trim() || '匿名';
            const newResult = {
                date: new Date(),
                user: userName,
                quiz: `${currentQuizInfo.key} ${currentQuizInfo.scaleText} (${currentQuizInfo.chordTypeText})`,
                time: timerDisplay.textContent,
                mistakes: mistakeCount
            };
            try {
                await addDoc(collection(db, "quizResults"), newResult);
            } catch (e) {
                console.error("Error adding document: ", e);
                alert("結果の保存に失敗しました。");
            }
        }

        async function loadResults() {
            resultsBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 py-4">読み込み中...</td></tr>';
            try {
                const q = query(collection(db, "quizResults"), orderBy("date", "desc"), limit(50));
                const querySnapshot = await getDocs(q);
                const results = [];
                querySnapshot.forEach((doc) => results.push(doc.data()));
                resultsBody.innerHTML = '';
                if (results.length === 0) {
                    resultsBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 py-4">まだ記録がありません。</td></tr>';
                    return;
                }
                results.forEach(result => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="whitespace-nowrap">${result.date.toDate().toLocaleString('ja-JP')}</td>
                        <td>${result.user}</td>
                        <td>${result.quiz}</td>
                        <td>${result.time}</td>
                        <td>${result.mistakes}</td>
                    `;
                    resultsBody.appendChild(row);
                });
            } catch (e) {
                console.error("Error loading results:", e);
                resultsBody.innerHTML = '<tr><td colspan="5" class="text-center text-red-500 py-4">結果の読み込みに失敗しました。</td></tr>';
            }
        }
        
        async function toggleResults() {
            const isHidden = resultsContainer.classList.contains('hidden');
            if (isHidden) {
                await loadResults();
                resultsContainer.classList.remove('hidden');
                toggleResultsBtn.textContent = '結果を隠す';
            } else {
                resultsContainer.classList.add('hidden');
                toggleResultsBtn.textContent = '結果を見る';
            }
        }

        // --- Event Listeners ---
        startGameBtn.addEventListener('click', () => {
            if (!userNameInput.value.trim()) {
                userNameInput.focus();
                alert('回答者名を入力してください。');
                return;
            }
            startScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');
            startRandomQuiz();
        });
        submitBtn.addEventListener('click', checkAnswers);
        nextQuestionBtn.addEventListener('click', startRandomQuiz);
        toggleResultsBtn.addEventListener('click', toggleResults);

    </script>
</body>
</html>



